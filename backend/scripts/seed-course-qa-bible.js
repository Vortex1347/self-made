const { Client } = require('pg');
const { loadEnvFromProjectRoot, getDbConfig } = require('./lib/env-loader');

loadEnvFromProjectRoot();

const isProduction =
  process.env.API_ENVIRONMENT === 'production' || process.env.NODE_ENV === 'production';

if (isProduction && process.env.FORCE_TEST_SEED !== 'true') {
  console.error(
    'Refusing to seed course demo content in production. Set FORCE_TEST_SEED=true only if this is intentional.',
  );
  process.exit(1);
}

const COURSE_MODULES = [
  {
    id: '70000000-0000-0000-0000-000000000001',
    title: 'Модуль 1. Роль QA и база тестирования',
    orderIndex: 1,
    isPublished: true,
    topics: [
      {
        id: '71000000-0000-0000-0000-000000000001',
        title: 'QA и Tester: кто за что отвечает',
        orderIndex: 1,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Новичкам важно разделять роли: Tester в основном проверяет конкретные сценарии, а QA отвечает за качество процесса и продукта в целом.',
          },
          {
            type: 'list',
            value: [
              'Tester: выполняет проверки и фиксирует факты',
              'QA: строит процесс, снижает риски качества',
              'Обе роли работают с командой разработки и бизнеса',
            ],
          },
        ],
        trainer: {
          type: 'case-builder',
          title: 'Мини-тренажер: зона ответственности',
          description: 'Опиши, что в вашем кейсе делает Tester, а что делает QA.',
        },
      },
      {
        id: '71000000-0000-0000-0000-000000000002',
        title: 'Верификация и валидация простыми словами',
        orderIndex: 2,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Верификация отвечает на вопрос «правильно ли мы сделали?», валидация — «то ли мы сделали для пользователя?».',
          },
          {
            type: 'list',
            value: [
              'Верификация: сверяем с требованиями и спецификацией',
              'Валидация: проверяем ценность и ожидаемое поведение на реальных сценариях',
              'Обе практики нужны, чтобы уменьшить количество дорогих ошибок',
            ],
          },
        ],
        trainer: null,
      },
      {
        id: '71000000-0000-0000-0000-000000000003',
        title: 'SDLC и STLC: где QA приносит максимум пользы',
        orderIndex: 3,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Чем раньше QA подключается к этапам жизненного цикла, тем дешевле исправления и стабильнее релизы.',
          },
          {
            type: 'list',
            value: [
              'Анализ требований',
              'Планирование тестирования',
              'Подготовка тестовых данных и окружения',
              'Исполнение, отчетность, ретроспектива качества',
            ],
          },
        ],
        trainer: null,
      },
    ],
  },
  {
    id: '70000000-0000-0000-0000-000000000002',
    title: 'Модуль 2. Тест-дизайн и документация',
    orderIndex: 2,
    isPublished: true,
    topics: [
      {
        id: '72000000-0000-0000-0000-000000000001',
        title: 'Техники тест-дизайна без перегруза',
        orderIndex: 1,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Начни с трех техник: классы эквивалентности, граничные значения и таблицы решений — этого хватает для большинства задач junior QA.',
          },
          {
            type: 'list',
            value: [
              'Классы эквивалентности: меньше тестов, то же покрытие',
              'Границы: где чаще всего ломается логика',
              'Таблица решений: системная проверка правил и комбинаций',
            ],
          },
        ],
        trainer: {
          type: 'case-builder',
          title: 'Тренажер: набор тестов для формы',
          description: 'Составь 5 проверок на форму регистрации с использованием трех техник.',
        },
      },
      {
        id: '72000000-0000-0000-0000-000000000002',
        title: 'Как писать понятные тест-кейсы и чек-листы',
        orderIndex: 2,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Хороший тест-кейс должен быть коротким, проверяемым и понятным без устных пояснений. Чек-лист подходит для быстрых прогонов.',
          },
          {
            type: 'list',
            value: [
              'Один кейс — одна цель',
              'Шаги и ожидаемый результат без двусмысленности',
              'Для регрессии удобно вести чек-лист по критичным функциям',
            ],
          },
        ],
        trainer: null,
      },
      {
        id: '72000000-0000-0000-0000-000000000003',
        title: 'Баг-репорт, который реально ускоряет фиксы',
        orderIndex: 3,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Главная цель баг-репорта — быстро воспроизвести проблему и принять решение о приоритете.',
          },
          {
            type: 'list',
            value: [
              'Четкий заголовок и ожидаемый/фактический результат',
              'Шаги воспроизведения и окружение',
              'Severity/Priority с объяснением влияния на пользователя',
            ],
          },
        ],
        trainer: {
          type: 'case-builder',
          title: 'Тренажер: оформи баг',
          description: 'На основе описания дефекта составь баг-репорт по шаблону команды.',
        },
      },
    ],
  },
  {
    id: '70000000-0000-0000-0000-000000000003',
    title: 'Модуль 3. Web и API',
    orderIndex: 3,
    isPublished: true,
    topics: [
      {
        id: '73000000-0000-0000-0000-000000000001',
        title: 'Клиент-сервер и HTTP: что нужно QA',
        orderIndex: 1,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Понимание клиент-серверной модели помогает быстрее локализовать дефект: фронт, бэкенд, интеграция или данные.',
          },
          {
            type: 'list',
            value: [
              'HTTP-методы и статусы ответа',
              'Headers, auth, cookies/session',
              'Как читать запрос и ответ в DevTools/Postman',
            ],
          },
        ],
        trainer: null,
      },
      {
        id: '73000000-0000-0000-0000-000000000002',
        title: 'API тестирование: минимальный рабочий набор',
        orderIndex: 2,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Для уверенного старта в API тестировании достаточно научиться проверять happy path, ошибки валидации и права доступа.',
          },
          {
            type: 'list',
            value: [
              'Smoke на ключевые эндпоинты',
              'Негативные проверки и коды ошибок',
              'Проверка бизнес-правил и связей между методами',
            ],
          },
        ],
        trainer: {
          type: 'api-check',
          title: 'Тренажер: API smoke + negative',
          description: 'Собери чек-лист для 3 эндпоинтов: success, validation error, unauthorized.',
        },
      },
      {
        id: '73000000-0000-0000-0000-000000000003',
        title: 'JSON в API ответах: как быстро валидировать',
        orderIndex: 3,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'JSON удобен тем, что его можно проверять автоматически: обязательные поля, типы данных и значения по правилам.',
          },
          {
            type: 'list',
            value: [
              'Проверка структуры (schema)',
              'Проверка nullable/required полей',
              'Сравнение фактических значений с тестовыми данными',
            ],
          },
        ],
        trainer: null,
      },
    ],
  },
  {
    id: '70000000-0000-0000-0000-000000000004',
    title: 'Модуль 4. Данные, SQL и окружение',
    orderIndex: 4,
    isPublished: true,
    topics: [
      {
        id: '74000000-0000-0000-0000-000000000001',
        title: 'Базы данных для QA: как мыслить таблицами',
        orderIndex: 1,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'QA не обязан быть DBA, но должен понимать, где хранится важная бизнес-информация и как проверить целостность данных.',
          },
          {
            type: 'list',
            value: [
              'Таблицы, ключи, связи',
              'Что такое нормальные и аномальные данные',
              'Когда идти в БД для проверки после API/UI действий',
            ],
          },
        ],
        trainer: null,
      },
      {
        id: '74000000-0000-0000-0000-000000000002',
        title: 'SQL для тестировщика: практический минимум',
        orderIndex: 2,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Твоя база на старте: SELECT, WHERE, JOIN, GROUP BY. Этого хватает, чтобы валидировать данные в большинстве задач junior QA.',
          },
          {
            type: 'list',
            value: [
              'SELECT + фильтрация',
              'JOIN для проверки связей',
              'GROUP BY для сверки агрегатов',
            ],
          },
        ],
        trainer: {
          type: 'sql',
          title: 'Тренажер: SQL проверка транзакции',
          description: 'Напиши SQL-запрос, который подтвердит корректность операции оплаты.',
        },
      },
      {
        id: '74000000-0000-0000-0000-000000000003',
        title: 'Linux и логи: быстрый анализ проблем',
        orderIndex: 3,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Базовые Linux-команды и чтение логов помогают QA быстрее находить причину дефекта и давать разработке полезный контекст.',
          },
          {
            type: 'list',
            value: ['cd/ls/cat/grep', 'Поиск ошибок по trace id', 'Как приложить лог в баг-репорт'],
          },
        ],
        trainer: null,
      },
    ],
  },
  {
    id: '70000000-0000-0000-0000-000000000005',
    title: 'Модуль 5. Подготовка к работе и интервью',
    orderIndex: 5,
    isPublished: true,
    topics: [
      {
        id: '75000000-0000-0000-0000-000000000001',
        title: 'Как собрать портфолио junior QA',
        orderIndex: 1,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'Портфолио должно показывать, как ты думаешь как QA: кейсы, баг-репорты, API/SQL проверки и выводы по качеству.',
          },
          {
            type: 'list',
            value: [
              '1-2 учебных проекта с артефактами',
              'Скриншоты и короткие пояснения решений',
              'Публичный репозиторий GitHub с понятной структурой',
            ],
          },
        ],
        trainer: null,
      },
      {
        id: '75000000-0000-0000-0000-000000000002',
        title: 'Собеседование QA: частые вопросы и логика ответа',
        orderIndex: 2,
        isPublished: true,
        contentBlocks: [
          {
            type: 'text',
            value:
              'На интервью важны не заученные определения, а то, как ты рассуждаешь: риски, приоритеты и проверка гипотез.',
          },
          {
            type: 'list',
            value: [
              'Как тестировать форму/фичу с нуля',
              'Как оформить дефект и оценить критичность',
              'Как объяснить выбор тест-дизайн техник',
            ],
          },
        ],
        trainer: {
          type: 'case-builder',
          title: 'Тренажер: интервью-кейс',
          description: 'Разбери задачу «проверить авторизацию» и предложи тестовую стратегию.',
        },
      },
    ],
  },
];

const TOPIC_VARIANTS = {
  '71000000-0000-0000-0000-000000000001': {
    caseStudy:
      'Команда запускает новый flow онбординга. Нужно разделить задачи: что проверяет tester в спринте, а что QA выстраивает на уровне процесса.',
    mistakes: [
      'Смешивать роль проверки и роль улучшения процесса',
      'Не фиксировать критерии качества до начала тестирования',
      'Работать только “по факту багов” без профилактики',
    ],
    practice: 'Сделай таблицу ответственности QA/Tester для релиза личного кабинета (этапы: план, тест, выпуск).',
    homework:
      'Опиши 5 действий QA до начала тестирования фичи и 5 действий tester во время прогонов.',
    interviewHint: 'Объясни разницу QA и tester через пример из реального спринта.',
  },
  '71000000-0000-0000-0000-000000000002': {
    caseStudy:
      'Требование “удобная регистрация” реализовано технично верно, но пользователи бросают форму. Нужно развести верификацию и валидацию.',
    mistakes: [
      'Проверять только соответствие ТЗ и игнорировать пользовательский путь',
      'Не согласовывать критерии “удобства” с продуктом',
      'Не проводить проверку на целевой аудитории',
    ],
    practice: 'Собери 3 проверки верификации и 3 проверки валидации для формы регистрации.',
    homework: 'Сделай мини-отчет: где результат “correct by spec”, но “bad for user”.',
    interviewHint: 'На интервью покажи разницу через один конкретный экран.',
  },
  '71000000-0000-0000-0000-000000000003': {
    caseStudy:
      'QA подключили только на финальном тестировании, и релиз задержался из-за критичных дефектов. Нужно пересобрать участие QA по этапам SDLC/STLC.',
    mistakes: [
      'Позднее вовлечение QA',
      'Нет тестовой стратегии до разработки',
      'Нет ретроспективы качества после релиза',
    ],
    practice: 'Построй карту SDLC/STLC и добавь точки контроля качества в каждом этапе.',
    homework: 'Подготовь шаблон “Definition of Ready for QA” для новой user story.',
    interviewHint: 'Объясни, как раннее QA-участие экономит бюджет команды.',
  },
  '72000000-0000-0000-0000-000000000001': {
    caseStudy:
      'Нужно быстро протестировать форму оплаты с множеством условий скидок. Без техник тест-дизайна кейсов становится слишком много.',
    mistakes: [
      'Писать тесты “в лоб” без группировки входных данных',
      'Пропускать граничные значения',
      'Не фиксировать логику решений в таблице',
    ],
    practice: 'Для поля “сумма” выпиши классы эквивалентности и границы, затем собери таблицу решений.',
    homework: 'Собери 12 тестов, покрывающих скидки, купоны и ошибки валидации.',
    interviewHint: 'Покажи, как ты уменьшил число тестов без потери покрытия.',
  },
  '72000000-0000-0000-0000-000000000002': {
    caseStudy:
      'После передачи тест-кейсов другой QA не смог воспроизвести половину проверок — формулировки оказались размытыми.',
    mistakes: [
      'Ожидаемый результат в стиле “должно работать”',
      'Смешивание нескольких проверок в одном кейсе',
      'Отсутствие предусловий и тестовых данных',
    ],
    practice: 'Возьми сырой кейс и перепиши его в формат: предусловия → шаги → ожидание.',
    homework: 'Сделай чек-лист smoke для авторизации, профиля и выхода из аккаунта.',
    interviewHint: 'Расскажи, как делаешь тест-кейс “самодостаточным” для коллеги.',
  },
  '72000000-0000-0000-0000-000000000003': {
    caseStudy:
      'Разработчик вернул баг “cannot reproduce”. Причина: в репорте не хватало окружения и данных, чтобы повторить проблему.',
    mistakes: [
      'Нет точных шагов воспроизведения',
      'Не указаны версия, окружение и входные данные',
      'Приоритет указан без бизнес-обоснования',
    ],
    practice: 'Оформи баг-репорт на сломанную смену пароля: шаги, факт, ожидание, severity, priority.',
    homework: 'Подготовь 3 баг-репорта разной критичности на один и тот же модуль.',
    interviewHint: 'Поясни, как отличаешь severity от priority на практике.',
  },
  '73000000-0000-0000-0000-000000000001': {
    caseStudy:
      'Пользователь видит ошибку на UI, но причина в бэкенд-контракте. Нужно локализовать слой проблемы через HTTP.',
    mistakes: [
      'Сразу обвинять один слой системы без проверки',
      'Не смотреть request/response в DevTools',
      'Игнорировать headers и статус-коды',
    ],
    practice: 'Разбери 3 неуспешных HTTP-ответа и определи: фронт, бэк или интеграция.',
    homework: 'Собери шпаргалку по ключевым HTTP-кодам для QA.',
    interviewHint: 'Покажи алгоритм “куда смотреть первым делом” при UI-ошибке.',
  },
  '73000000-0000-0000-0000-000000000002': {
    caseStudy:
      'У API есть happy-path тесты, но на проде падает валидация и авторизация. Нужно расширить набор проверок.',
    mistakes: [
      'Покрывать только успешные ответы',
      'Не проверять бизнес-правила на связке эндпоинтов',
      'Игнорировать негативные сценарии доступа',
    ],
    practice: 'Собери матрицу API-проверок: success, validation, auth, permission, idempotency.',
    homework: 'Подготовь коллекцию Postman для smoke + 5 негативных сценариев.',
    interviewHint: 'Расскажи, какой минимум API-проверок ты делаешь в первый день проекта.',
  },
  '73000000-0000-0000-0000-000000000003': {
    caseStudy:
      'После релиза клиент падает из-за missing-поля в JSON. Нужно заранее ловить такие дефекты проверкой схемы.',
    mistakes: [
      'Проверять только “примерно похожий” ответ',
      'Не валидировать типы полей',
      'Не отслеживать optional/required изменения',
    ],
    practice: 'Для ответа профиля опиши JSON-schema и негативный кейс с неверным типом поля.',
    homework: 'Добавь автопроверки на обязательные поля в 3 ключевых API-методах.',
    interviewHint: 'Покажи, как schema-check экономит время регрессии.',
  },
  '74000000-0000-0000-0000-000000000001': {
    caseStudy:
      'После успешной оплаты UI показывает “успешно”, но в БД нет ожидаемой записи. Нужно проверить целостность данных.',
    mistakes: [
      'Доверять только UI без проверки хранилища',
      'Не понимать связи таблиц',
      'Проверять данные без фильтра по конкретной транзакции',
    ],
    practice: 'Построй схему: user → order → payment и определи, какие поля сверять после оплаты.',
    homework: 'Составь чек-лист проверки данных после 3 бизнес-операций.',
    interviewHint: 'Объясни, когда QA обязан идти в БД, а когда это избыточно.',
  },
  '74000000-0000-0000-0000-000000000002': {
    caseStudy:
      'API вернуло “успех”, но сумма заказа в отчетах неверная. Проверка SQL выявляет ошибку join/group.',
    mistakes: [
      'Использовать SELECT * без понимания полей',
      'Неверно собирать JOIN и получать дубли',
      'Не сверять агрегаты с фактическими бизнес-цифрами',
    ],
    practice: 'Напиши запросы: выборка заказа, join с платежами, group by по статусам.',
    homework: 'Собери 5 SQL-запросов для ежедневной QA-проверки критичных данных.',
    interviewHint: 'Покажи, как SQL помогает подтвердить или опровергнуть дефект.',
  },
  '74000000-0000-0000-0000-000000000003': {
    caseStudy:
      'Инцидент проявляется только ночью, и без логов дефект не воспроизводится. Нужно быстро отфильтровать ключевые записи.',
    mistakes: [
      'Искать проблему без временного диапазона и trace id',
      'Не фиксировать найденные логи в баг-репорте',
      'Использовать команды Linux без понимания контекста',
    ],
    practice: 'Смоделируй разбор лога: найди ошибку по trace id и собери краткую хронологию.',
    homework: 'Сделай набор Linux-команд для первичного QA-debug в прод-like окружении.',
    interviewHint: 'Расскажи, как ты превращаешь “лог-шум” в понятный вывод для команды.',
  },
  '75000000-0000-0000-0000-000000000001': {
    caseStudy:
      'Кандидат говорит “умею тестировать”, но не может показать реальные артефакты. Нужно собрать портфолио, которое продает навык.',
    mistakes: [
      'Показывать только сертификаты без практических примеров',
      'Не объяснять, какую проблему решал каждый артефакт',
      'Хранить материалы без структуры и контекста',
    ],
    practice: 'Собери структуру GitHub-репозитория портфолио: кейсы, баги, API/SQL, выводы.',
    homework: 'Подготовь 2 проекта-портфолио с читаемым README и примерами решений.',
    interviewHint: 'Объясни, как каждый артефакт подтверждает конкретный QA-навык.',
  },
  '75000000-0000-0000-0000-000000000002': {
    caseStudy:
      'На техническом интервью кандидат знает термины, но теряется в кейс-вопросах. Нужно натренировать структуру ответа.',
    mistakes: [
      'Отвечать определениями без практического контекста',
      'Не проговаривать риски и приоритеты',
      'Не уметь защитить выбор проверок',
    ],
    practice: 'Разбери 3 интервью-кейса: авторизация, корзина, профиль — с приоритетом проверок.',
    homework: 'Запиши 10 ответов на частые вопросы junior QA по структуре “контекст → риск → проверка → вывод”.',
    interviewHint: 'Демонстрируй логику принятия решений, а не только знание терминов.',
  },
};

function extractTopicSource(topic) {
  const textChunks = [];
  const listItems = [];

  for (const block of topic.contentBlocks || []) {
    if (!block || typeof block !== 'object') continue;
    if (block.type === 'text' && typeof block.value === 'string' && block.value.trim()) {
      textChunks.push(block.value.trim());
    }
    if (block.type === 'list' && Array.isArray(block.value)) {
      for (const item of block.value) {
        if (typeof item === 'string' && item.trim()) {
          listItems.push(item.trim());
        }
      }
    }
  }

  return { textChunks, listItems };
}

function pickTopicTerms(topic, source) {
  const fallback = [
    `${topic.title}: базовые принципы`,
    'Ключевые шаги проверки',
    'Риски и типовые ошибки',
    'Критерии готовности результата',
    'Коммуникация с командой',
    'Практика и закрепление',
  ];

  const combined = [...source.listItems, ...source.textChunks];
  const normalized = combined
    .map((value) => value.replace(/\s+/g, ' ').trim())
    .filter(Boolean)
    .slice(0, 10);

  return (normalized.length ? normalized : fallback).slice(0, 6);
}

function buildExpandedBlocks(moduleTitle, topic) {
  const source = extractTopicSource(topic);
  const terms = pickTopicTerms(topic, source);
  const variant = TOPIC_VARIANTS[topic.id] || {};
  const baseIntro =
    source.textChunks[0] ||
    `В этой теме ты разберешь ${topic.title.toLowerCase()} простым языком и на практических примерах.`;

  const topicTitle = topic.title;
  const modulePart = moduleTitle.toLowerCase();

  return [
    {
      type: 'text',
      value: `Раздел 1. О чем эта тема\n${baseIntro} Мы не идем в сухую теорию: фокус на том, как новичку применить знания в задачах уровня junior QA уже в первом проекте.`,
    },
    {
      type: 'text',
      value: `Раздел 2. Зачем это нужно в реальной работе\n${topicTitle} напрямую влияет на скорость поиска дефектов, качество релизов и то, насколько уверенно ты общаешься с разработкой и продуктом. В модуле «${modulePart}» эта тема связана с соседними уроками, поэтому мы будем постоянно возвращаться к общему процессу тестирования.`,
    },
    {
      type: 'text',
      value: `Раздел 3. Модель мышления QA\nНачинай не с инструмента, а с цели проверки: что может сломаться, какая ценность для пользователя, какой риск для бизнеса и какие данные нужны, чтобы подтвердить вывод. Такая логика делает твою работу предсказуемой и понятной для команды.`,
    },
    {
      type: 'list',
      value: terms,
    },
    {
      type: 'text',
      value: `Раздел 4. Пошаговый алгоритм\nШаг 1: уточни ожидаемое поведение.\nШаг 2: выдели позитивные и негативные сценарии.\nШаг 3: подготовь данные и окружение.\nШаг 4: зафиксируй результаты и выводы.\nШаг 5: если найден дефект — оформи его так, чтобы команда могла быстро воспроизвести и исправить.`,
    },
    {
      type: 'text',
      value: `Раздел 5. Мини-кейс из практики\n${
        variant.caseStudy ||
        `Представь, что в продукте добавили новую фичу, связанную с темой «${topicTitle}». Новичок часто проверяет только happy path и получает «ложно-зеленый» результат. Профессиональный подход: пройти граничные условия, ошибки валидации, поведение после обновления страницы, влияние на связанные сущности и доступы пользователей.`
      }`,
    },
    {
      type: 'text',
      value: `Раздел 6. Типовые ошибки новичка\n${
        Array.isArray(variant.mistakes) && variant.mistakes.length
          ? variant.mistakes.map((item, index) => `${index + 1}) ${item}`).join('\n')
          : '1) Нет явного ожидаемого результата.\n2) Проверки не покрывают рискованные сценарии.\n3) Пропуск проверки данных после действия.\n4) Слишком общие баг-репорты.\n5) Проверка «по ощущениям», а не по критериям.'
      } Если убрать эти ошибки, качество твоих артефактов вырастет очень заметно.`,
    },
    {
      type: 'text',
      value: `Раздел 7. Чек-лист контроля качества темы\nПеред завершением урока проверь себя: можешь ли ты объяснить тему простыми словами, составить набор проверок, подобрать тестовые данные, описать риски и предложить минимальный regression-check. Если хотя бы один пункт вызывает сложность — это точка, которую стоит повторить.`,
    },
    {
      type: 'text',
      value: `Раздел 8. Как говорить об этом на интервью\n${
        variant.interviewHint ||
        'На собеседовании важно не просто дать определение, а показать ход мыслей: как ты выбираешь приоритеты, почему именно такие проверки запускаешь первыми и как принимаешь решение, что релиз безопасен.'
      } В ответах используй структуру: контекст → риск → проверка → критерий результата.`,
    },
    {
      type: 'list',
      value: [
        'Вопрос для самопроверки: какой главный риск в этой теме?',
        'Вопрос для самопроверки: какие 3 проверки ты запускаешь первыми?',
        'Вопрос для самопроверки: как поймешь, что результат корректный?',
        'Вопрос для самопроверки: как оформить дефект по этой теме?',
        'Вопрос для самопроверки: что проверить повторно после фикса?',
      ],
    },
    {
      type: 'text',
      value: `Раздел 9. Практикум\n${
        variant.practice ||
        `Открой тестовый стенд или демо-сервис и выполни не меньше 10 проверок по теме «${topicTitle}»: минимум 4 позитивные, 4 негативные и 2 граничные.`
      } Отдельно запиши, какие проверки дали наибольшую ценность и почему.`,
    },
    {
      type: 'text',
      value: `Раздел 10. Домашнее задание\n${
        variant.homework ||
        'Подготовь мини-артефакт: чек-лист или тест-кейсы, 1-2 потенциальных баг-репорта и короткий вывод о рисках.'
      } Цель — собрать материал, который потом можно положить в портфолио junior QA как доказательство практического навыка, а не только теории.`,
    },
    {
      type: 'text',
      value: `Итог темы\nЕсли ты дочитал до конца, значит у тебя уже есть рабочая схема: как понять задачу, как проверить ее системно и как донести результат до команды. Повтори этот же подход на следующей теме модуля — и постепенно ты соберешь устойчивую профессиональную базу QA.`,
    },
  ];
}

function buildSelfCheckFromTopic(moduleTitle, topic, contentBlocks) {
  const source = extractTopicSource({ contentBlocks });
  const terms = pickTopicTerms(topic, source);
  const keyPhraseA = terms[0] || `${topic.title}: базовые принципы`;
  const keyPhraseB = terms[1] || 'Ключевые шаги проверки';
  const keyPhraseC = terms[2] || 'Риски и типовые ошибки';

  return {
    title: `Тест по теме: ${topic.title}`,
    description: `Самопроверка по теме модуля «${moduleTitle}».`,
    questions: [
      {
        question: `Какая формулировка лучше всего относится к теме «${topic.title}»?`,
        options: [
          keyPhraseA,
          'Пропустить анализ требований и сразу выпускать релиз',
          'Игнорировать негативные проверки',
        ],
        correctIndex: 0,
      },
      {
        question: 'Что должен включать базовый набор проверок по теме?',
        options: [
          'Позитивные и негативные сценарии + критерии результата',
          'Только happy path без фиксации результата',
          'Только визуальная проверка интерфейса',
        ],
        correctIndex: 0,
      },
      {
        question: 'Какой пункт из списка темы является корректным?',
        options: [keyPhraseB, 'Не фиксировать дефекты в баг-репорте', 'Отключить проверку данных'],
        correctIndex: 0,
      },
      {
        question: 'Какой риск важно контролировать в этой теме?',
        options: [
          keyPhraseC,
          'Не проверять результат после исправления',
          'Удалять шаги воспроизведения из баг-репорта',
        ],
        correctIndex: 0,
      },
    ],
  };
}

function withExpandedArticles(modules) {
  return modules.map((moduleItem) => ({
    ...moduleItem,
    topics: moduleItem.topics.map((topic) => {
      const contentBlocks = buildExpandedBlocks(moduleItem.title, topic);
      return {
        ...topic,
        contentBlocks,
        trainer: buildSelfCheckFromTopic(moduleItem.title, topic, contentBlocks),
      };
    }),
  }));
}

function flattenTopics(modules) {
  return modules.flatMap((moduleItem) =>
    moduleItem.topics.map((topic) => ({
      id: topic.id,
      moduleId: moduleItem.id,
      title: topic.title,
      orderIndex: topic.orderIndex,
      isPublished: topic.isPublished,
      contentBlocks: topic.contentBlocks,
      trainer: topic.trainer,
    })),
  );
}

async function seedCourse(client) {
  const expandedModules = withExpandedArticles(COURSE_MODULES);
  const topics = flattenTopics(expandedModules);

  await client.query('BEGIN');
  try {
    await client.query('DELETE FROM "topic_comment"');
    await client.query('DELETE FROM "course_topic"');
    await client.query('DELETE FROM "course_module"');

    for (const moduleItem of expandedModules) {
      await client.query(
        `
          INSERT INTO "course_module" ("id", "title", "order_index", "is_published")
          VALUES ($1, $2, $3, $4)
        `,
        [moduleItem.id, moduleItem.title, moduleItem.orderIndex, moduleItem.isPublished],
      );
    }

    for (const topic of topics) {
      await client.query(
        `
          INSERT INTO "course_topic" (
            "id", "module_id", "title", "order_index", "content_blocks", "trainer", "is_published"
          )
          VALUES ($1, $2, $3, $4, $5::jsonb, $6::jsonb, $7)
        `,
        [
          topic.id,
          topic.moduleId,
          topic.title,
          topic.orderIndex,
          JSON.stringify(topic.contentBlocks || []),
          topic.trainer ? JSON.stringify(topic.trainer) : null,
          topic.isPublished,
        ],
      );
    }

    await client.query('COMMIT');

    console.log(`Course seeded: ${COURSE_MODULES.length} modules, ${topics.length} topics.`);
    console.log('Content style: beginner-friendly adaptation based on QA Bible section structure.');
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  }
}

async function main() {
  const { host, port, appUser: user, appPassword: password, database } = getDbConfig();
  const client = new Client({ host, port, user, password, database });

  try {
    await client.connect();
    await seedCourse(client);
  } catch (error) {
    console.error(error.message);
    process.exit(1);
  } finally {
    await client.end();
  }
}

main();
