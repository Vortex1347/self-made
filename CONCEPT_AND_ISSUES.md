# QA Academy — концепт и разбор проблем

## 1. Концепт (как промпт для воспроизведения идеи)

Ниже — сжатое описание продукта в формате промпта, по которому можно восстановить идею и доработать проект.

---

**Промпт-концепт:**

«Собери MVP платформы обучения QA (QA Academy):

**Роли:** администратор (CRM), ученик (портал).

**Логика доступа:**
- Админ вручную создаёт учеников (имя, логин, пароль) и выставляет дату окончания доступа (`accessUntil`).
- Подписка = доступ до указанной даты включительно. После этой даты ученик не может открывать темы и тренажёры, только видит сообщение о продлении.
- Нет автоматических платежей — продление только через админа в CRM.

**Структура курса:**
- Модули → темы. У каждой темы: заголовок, контент-блоки (текст, список, изображение), опционально тренажёр.
- Тренажёр — отдельная зона (layout: слева контент темы, справа окно тренажера). Типы: case-builder, api-check, sql и т.п.; пока заглушка «здесь будет backend-тренажёр».

**Комментарии:**
- У каждой темы — комментарии в формате мини-чата (список под темой или в боковой панели).
- Ученик видит все комментарии по теме, добавляет новые, редактирует/удаляет только свои.
- Админ в CRM видит все комментарии по всем темам, может редактировать любой (с пометкой editedByAdmin) и удалять.

**Фронт (MVP):**
- Лендинг (главная), CRM (управление учениками + модерация комментариев), портал ученика (вход по логину/паролю, навигация по модулям/темам, контент + тренажёр + комментарии).
- Сначала можно на localStorage и статическом курсе; потом переключить на API.

**Бэкенд (API):**
- Auth: админ (JWT), ученик (отдельный JWT с type: student).
- CRM: CRUD учеников, выдача/обновление доступа до даты; список/редактирование/удаление комментариев.
- Публичные (для ученика под JWT): логин ученика, /me, список модулей/тем, контент темы, CRUD своих комментариев по теме. На всех эндпоинтах ученика — проверка, что доступ не истёк (accessUntil >= сегодня).»

---

По этому описанию можно восстановить текущую задумку и дорабатывать фронт/бэкенд согласованно.

---

## 2. Что не так (разбор по проекту)

### 2.1 Backend: модули и маршруты не подключены

**Проблема:** В `backend/src/app.module.ts` подключены только:
- `AuthControllerModule` (админ: login, me)
- `HealthControllerModule`

**Не подключены:**
- `AdminStudentControllerModule` — CRM учеников (GET/POST/PATCH/DELETE)
- `AdminCommentControllerModule` — модерация комментариев
- `StudentAuthControllerModule` — вход ученика и `/me`
- Публичный курс: модуль с `CourseController` (GET modules, GET topic)
- Публичные комментарии: модуль с `TopicCommentController` (GET/POST/PATCH/DELETE по теме)

**Итог:** Вся логика учеников, курса и комментариев в коде есть, но маршруты не регистрируются, API фактически не работает.

**Что сделать:** В `app.module.ts` добавить импорты и в массив `imports`:
- `AdminStudentControllerModule`
- `AdminCommentControllerModule`
- `StudentAuthControllerModule`
- Модуль с `CourseController` (public/course)
- Модуль с `TopicCommentController` (public/topic-comment)

---

### 2.2 Backend: БД — миграция не совпадает с сущностями

**Проблема:** В `backend/src/migrations/1739000000000-InitialSchema.ts` создаётся только таблица `user_account`. В коде же есть сущности и репозитории для:
- `student_account` (StudentEntity)
- `course_module` (CourseModuleEntity)
- `course_topic` (CourseTopicEntity)
- `topic_comment` (TopicCommentEntity)

Таблиц для них в миграции нет.

**Итог:** При `synchronize: false` (продакшен/по умолчанию) приложение упадёт при обращении к студентам/курсу/комментариям (таблицы отсутствуют). При `synchronize: true` TypeORM создаст таблицы сам, но миграции и реальная схема разойдутся.

**Что сделать:** Добавить миграции, создающие таблицы `student_account`, `course_module`, `course_topic`, `topic_comment` (и при необходимости сиды модулей/тем), либо временно в dev использовать `API_ENVIRONMENT=develop` и synchronize, но потом обязательно выровнять миграции.

---

### 2.3 Backend: DbModule и сущности

**Проблема:** В `backend/src/infrastructure/db/db.module.ts` в `TypeOrmModule.forFeature([...])` указана только `UserEntity`. Остальные сущности подключаются через форFeature в своих сервис-модулях (Student, Course, Comment). Глобально в `dataSourceOptions` используется glob по `entities/*.entity{.ts,.js}`, поэтому при forRoot все сущности подхватываются. То есть для работы приложения после добавления модулей в AppModule и наличия таблиц (миграции или synchronize) этого достаточно. Явная несогласованность: в DbModule фигурирует только User — для ясности и будущего масштабирования лучше либо зарегистрировать все сущности в одном месте, либо явно описать в README, что сущности подключаются в feature-модулях.

**Рекомендация:** Оставить подключение сущностей в модулях сервисов, но добавить в README или комментарий в DbModule, что корневой DataSource подхватывает все entity из папки entities (по glob).

---

### 2.4 Frontend и Backend: данные не связаны

**Проблема:** Фронт работает только с `localStorage` и захардкоженным курсом в `frontend/app-data.js` (COURSE_DATA с id вида `module-1`, `topic-1-1`). Бэкенд рассчитан на UUID для модулей и тем и на ответы API (список модулей/тем, контент темы, комментарии). Фронт нигде не вызывает API, нет единого слоя (например, `api.js`) для запросов к бэкенду.

**Итог:** Два параллельных мира: «полный» MVP на localStorage и почти готовый API, который не используется.

**Что сделать:** По шагам из README: поднять API, добавить слой запросов к нему (логин админа/ученика, ученик: курс, темы, комментарии; админ: ученики, комментарии), заменить чтение/запись учеников и комментариев на вызовы API. ID модулей/тем брать из ответов API (UUID), а не из статического COURSE_DATA.

---

### 2.5 Frontend: пароль в открытом виде и «текущий ученик» в CRM

**Проблема:** В CRM пароль хранится и отображается в форме как обычное поле (и в localStorage в открытом виде). В бэкенде пароль правильно хранится как `passwordHash` (bcrypt). При переходе на API пароль не должен возвращаться в ответах и не должен храниться в открытом виде на клиенте.

**Дополнительно:** В CRM идея «выбрать текущего ученика» (getCurrentStudentLogin/setCurrentStudentLogin) — это удобство для теста «войти как этот ученик» на портале. При работе через API «текущий ученик» — это сессия самого ученика (JWT), а не выбор в CRM; эту логику при интеграции с API нужно убрать или переосмыслить (например, только для тестовой кнопки «Войти как» с отдельным токеном).

---

### 2.6 Backend: админ и CRM

**Проблема:** В CRM на фронте нет входа под админом: страница crm.html не использует JWT админа. Все эндпоинты `/api/v1/admin/*` защищены JwtAuthGuard (роль admin). Чтобы CRM работала через API, нужна страница/форма логина админа и сохранение/передача accessToken в заголовке запросов.

**Что сделать:** Добавить на фронте логин админа (POST /api/v1/auth/login), сохранять токен (например, в sessionStorage или памяти), подставлять его в Authorization для всех запросов к admin/students и admin/comments.

---

### 2.7 Несоответствие API комментариев (патч/удаление)

**Фронт (student.js):** Комментарии хранятся в массиве по теме, редактирование/удаление по `comment.id` без привязки к теме в URL.

**Бэкенд (TopicCommentController):**  
- PATCH/DELETE имеют вид: `api/public/topics/:topicId/comments/:id`.  
То есть для обновления/удаления комментария фронт должен вызывать URL с обоими параметрами (topicId и id комментария). Сейчас фронт так не делает (нет вызовов API). При интеграции нужно формировать запросы именно в таком формате.

---

### 2.8 Тренажёры

**Факт:** На фронте тренажёры — заглушки (тип и описание показываются, контент «здесь будет backend-тренажёр»). В бэкенде сущность темы хранит поле `trainer` (jsonb), но отдельного API для «запуска» или пошагового тренажера нет. Это ожидаемо для MVP; при развитии понадобится отдельный контракт (эндпоинты и формат заданий/проверок) для каждого типа тренажера.

---

### 2.9 backend-reference

**Факт:** Папка `backend-reference/` — другой скелет (магазин/каталог: товары, категории, металлы и т.д.), не домен QA Academy. В корневом README он помечен как «старый/альтернативный скелет как reference». Путаницы можно избежать, если в README явно написать: «Не используется в QA Academy; оставлен только как референс по структуре NestJS/миграций».

---

## 3. Краткий чек-лист исправлений

| # | Где | Что сделать |
|---|-----|-------------|
| 1 | backend `app.module.ts` | Подключить все модули контроллеров: AdminStudent, AdminComment, StudentAuth, public Course, public TopicComment |
| 2 | backend migrations | Добавить миграции для student_account, course_module, course_topic, topic_comment (и при необходимости сиды курса) |
| 3 | frontend | Ввести слой API: базовый URL, логин ученика/админа, запросы к курсу/комментариям/ученикам; заменить localStorage на вызовы API |
| 4 | frontend CRM | Добавить логин админа и передачу JWT в запросах к /api/v1/admin/* |
| 5 | frontend student | Использовать topicId и comment id в URL при PATCH/DELETE комментариев по формату бэкенда |
| 6 | docs | Уточнить в README про backend-reference и про то, что сущности подключаются в feature-модулях |

После этого текущая идея (концепт) и реализация будут согласованы, а основные «что не так» — закрыты.
